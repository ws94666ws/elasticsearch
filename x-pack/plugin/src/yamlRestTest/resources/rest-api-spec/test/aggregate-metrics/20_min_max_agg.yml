###############################################################################################################
# Test min and max aggregations on an index that contains aggregate_metric_double fields
###############################################################################################################

setup:
  - requires:
      test_runner_features: [ allowed_warnings ]
  - do:
      allowed_warnings:
        - "Parameter [default_metric] is deprecated and will be removed in a future version"
      indices.create:
        index:  aggregate_metric_test
        body:
          mappings:
            properties:
              metric:
                type: aggregate_metric_double
                metrics: [min, max, sum, value_count]
                default_metric: max

  - do:
      bulk:
        index: aggregate_metric_test
        refresh: true
        body:
          - # we keep max == avg so that the test will keep working bwc
          - '{"index": {}}'
          - '{"metric": {"min": 0, "max": 100, "sum": 1000, "value_count": 10} }'
          - '{"index": {}}'
          - '{"metric": {"min": 60, "max": 100, "sum": 1000, "value_count": 10} }'
          - '{"index": {}}'
          - '{"metric": {"min": -400.50, "max": 1000, "sum": 20000, "value_count": 20} }'
          - '{"index": {}}'
          - '{"metric": {"min": 1, "max": 99.3, "sum": 279.9, "value_count": 3} }'
          - '{"index": {}}'
          - '{"metric": {"min": -100, "max": -40, "sum": -80, "value_count": 2} }'
---
"Test min_max aggs":
  - do:
      search:
        index: aggregate_metric_test
        size: 0
        body:
          aggs:
            max_agg:
              max:
                field: metric
            min_agg:
              min:
                field: metric

  - match: { hits.total.value: 5 }
  - match: { aggregations.max_agg.value: 1000}
  - match: { aggregations.min_agg.value: -400.50}


---
"Test min_max aggs with query":
  - do:
      search:
        index: aggregate_metric_test
        size: 0
        body:
          query:
            term:
              metric:
                value: 100
          aggs:
            max_agg:
              max:
                field: metric
            min_agg:
              min:
                field: metric

  - match: { hits.total.value: 2 }
  - match: { aggregations.max_agg.value: 100}
  - match: { aggregations.min_agg.value: 0}
